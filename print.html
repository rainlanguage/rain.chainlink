<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="src/interface/index.html">❱ interface</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="src/interface/AggregatorV3Interface.sol/interface.AggregatorV3Interface.html">AggregatorV3Interface</a></li></ol></li><li class="chapter-item "><a href="src/lib/index.html">❱ lib</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="src/lib/LibChainlink.sol/error.NotPosIntPrice.html">NotPosIntPrice</a></li><li class="chapter-item "><a href="src/lib/LibChainlink.sol/error.StalePrice.html">StalePrice</a></li><li class="chapter-item "><a href="src/lib/LibChainlink.sol/library.LibChainlink.html">LibChainlink</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainprotocol/rain.chainlink" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rainchainlink"><a class="header" href="#rainchainlink">rain.chainlink</a></h1>
<pre><code class="language-solidity">/// @title LibChainlink
/// A library for interacting with Chainlink oracles. This library is designed
/// to be used with the `AggregatorV3Interface` interface, to be an opinionated
/// approach to using Chainlink oracles. The implementation is informed by both
/// the Chainlink documentation and real world experience using Chainlink.
/// Importantly it is designed for price feeds specifically, and not for
/// arbitrary oracle values. This is because price feeds are the most common
/// use case for Chainlink oracles, and the most common use case for Chainlink
/// oracles in the context of Rain Protocol.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contents"><a class="header" href="#contents">Contents</a></h1>
<ul>
<li><a href="src/interface/AggregatorV3Interface.sol/interface.AggregatorV3Interface.html">AggregatorV3Interface</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="aggregatorv3interface"><a class="header" href="#aggregatorv3interface">AggregatorV3Interface</a></h1>
<p><a href="https://github.com/rainprotocol/rain.chainlink/blob/84a0638b96769cb415db43655c452f9d860e0179/src/interface/AggregatorV3Interface.sol">Git Source</a></p>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="decimals"><a class="header" href="#decimals">decimals</a></h3>
<pre><code class="language-solidity">function decimals() external view returns (uint8);
</code></pre>
<h3 id="description"><a class="header" href="#description">description</a></h3>
<pre><code class="language-solidity">function description() external view returns (string memory);
</code></pre>
<h3 id="version"><a class="header" href="#version">version</a></h3>
<pre><code class="language-solidity">function version() external view returns (uint256);
</code></pre>
<h3 id="getrounddata"><a class="header" href="#getrounddata">getRoundData</a></h3>
<pre><code class="language-solidity">function getRoundData(uint80 _roundId)
    external
    view
    returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound);
</code></pre>
<h3 id="latestrounddata"><a class="header" href="#latestrounddata">latestRoundData</a></h3>
<pre><code class="language-solidity">function latestRoundData()
    external
    view
    returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contents-1"><a class="header" href="#contents-1">Contents</a></h1>
<ul>
<li><a href="src/lib/LibChainlink.sol/error.NotPosIntPrice.html">NotPosIntPrice</a></li>
<li><a href="src/lib/LibChainlink.sol/error.StalePrice.html">StalePrice</a></li>
<li><a href="src/lib/LibChainlink.sol/library.LibChainlink.html">LibChainlink</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notposintprice"><a class="header" href="#notposintprice">NotPosIntPrice</a></h1>
<p><a href="https://github.com/rainprotocol/rain.chainlink/blob/84a0638b96769cb415db43655c452f9d860e0179/src/lib/LibChainlink.sol">Git Source</a></p>
<p>Thrown if a price is zero or negative as this is probably not anticipated or
useful for most users of a price feed. Of course there are use cases where
zero or negative <em>oracle values</em> in general are useful, such as negative
temperatures from a thermometer, but these are unlikely to be useful <em>prices</em>
for assets. Zero value prices are likely to result in division by zero
downstream or giving away assets for free, negative price values could result
in even weirder behaviour due to token amounts being <code>uint256</code> and the
subtleties of signed vs. unsigned integer conversions.</p>
<pre><code class="language-solidity">error NotPosIntPrice(int256 price);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="staleprice"><a class="header" href="#staleprice">StalePrice</a></h1>
<p><a href="https://github.com/rainprotocol/rain.chainlink/blob/84a0638b96769cb415db43655c452f9d860e0179/src/lib/LibChainlink.sol">Git Source</a></p>
<p>Thrown when the updatedAt time from the Chainlink oracle is more than
staleAfter seconds prior to the current block timestamp. Prevents stale
prices from being used within the constraints set by the caller.</p>
<pre><code class="language-solidity">error StalePrice(uint256 updatedAt, uint256 staleAfter);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="libchainlink"><a class="header" href="#libchainlink">LibChainlink</a></h1>
<p><a href="https://github.com/rainprotocol/rain.chainlink/blob/84a0638b96769cb415db43655c452f9d860e0179/src/lib/LibChainlink.sol">Git Source</a></p>
<h2 id="functions-1"><a class="header" href="#functions-1">Functions</a></h2>
<h3 id="price"><a class="header" href="#price">price</a></h3>
<p>Returns a single price value from a Chainlink oracle. This wraps the
<code>latestRoundData</code> function from the <code>AggregatorV3Interface</code> interface
and adds some additional checks to ensure the price is valid. It also
scales the price to 18 decimal fixed point, which is the standard for
Rain Protocol, and more generally common for Ethereum tokens and ETH
itself. By scaling everything to 18 decimal fixed point we can avoid
having to deal with the complexities of different token decimals
downstream.
A &quot;valid&quot; price is nonzero and nonnegative, and not stale. This avoids
division by zero and other weird behaviour downstream. Stale prices are
avoided by checking the updatedAt time from the oracle is not more than
<code>staleAfter</code> seconds prior to the current block timestamp. This is NOT
a guarantee that the price is accurate, but it is a guarantee that the
price is not stale according to the constraints set by the caller. The
main issue with a time based check is that Chainlink doesn't report
onchain when the price <em>should</em> have changed, so there is no way to
know if the price is truly stale or not. This is a limitation of
Chainlink, and not this library. For example, Chainlink could silently
pause the oracle according to constraints that A. can only be known by
reading the oracle code and B. can change at any time due to the oracle
being upgradeable and controlled by a third party. I.e. you need to
re-read the oracle code every block, offchain, to really know what the
rules are. This happened in the past with the LUNA price feed and wiped
out several DeFi projects that relied on it. Chainlink documentation
recommends 24/7 monitoring of oracle prices by defi teams, and that
teams should pause their contracts if the oracle price is stale. At
best this is a very high bar for defi teams to meet, and at worst it
is impossible for protocols that are designed to be fully decentralized.
Invalid/stale prices will REVERT so the caller needs to handle this. If
somehow Chainlink returns a future updatedAt time, this will also REVERT.</p>
<pre><code class="language-solidity">function price(address feed, uint256 staleAfter, uint256 scalingFlags) internal view returns (uint256);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>feed</code></td><td><code>address</code></td><td>The address of the Chainlink oracle to read from.</td></tr>
<tr><td><code>staleAfter</code></td><td><code>uint256</code></td><td>The maximum number of seconds the caller allows between the block timestamp and the updated time.</td></tr>
<tr><td><code>scalingFlags</code></td><td><code>uint256</code></td><td>Flags to control the scaling of the price as per the <code>FixedPointDecimalScale</code> library. See that library for more details.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>The price from the oracle, scaled to 18 decimal fixed point.</td></tr>
</tbody></table>
</div>
<h3 id="rounddatatoprice"><a class="header" href="#rounddatatoprice">roundDataToPrice</a></h3>
<p>Internal logic for <code>price</code>. This is a separate function so it can be
tested in isolation. Ideally we'd not need this, but there seems to be
an issue when mocks and revert expectations are used together in
Foundry. This is a workaround for that issue.
https://github.com/foundry-rs/foundry/issues/5359
IT IS NOT RECOMMENDED TO USE THIS DIRECTLY. It will be removed if/when
the Foundry issue is resolved. Use <code>price</code> instead.</p>
<pre><code class="language-solidity">function roundDataToPrice(
    uint256 currentTimestamp,
    uint256 staleAfter,
    uint256 scalingFlags,
    int256 answer,
    uint256 updatedAt,
    uint8 decimals
) internal pure returns (uint256);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>currentTimestamp</code></td><td><code>uint256</code></td><td>The current block timestamp.</td></tr>
<tr><td><code>staleAfter</code></td><td><code>uint256</code></td><td>The maximum number of seconds the caller allows between the block timestamp and the updated time.</td></tr>
<tr><td><code>scalingFlags</code></td><td><code>uint256</code></td><td>Flags to control the scaling of the price as per the <code>FixedPointDecimalScale</code> library. See that library for more details.</td></tr>
<tr><td><code>answer</code></td><td><code>int256</code></td><td>The price from the oracle.</td></tr>
<tr><td><code>updatedAt</code></td><td><code>uint256</code></td><td>The time the oracle was last updated.</td></tr>
<tr><td><code>decimals</code></td><td><code>uint8</code></td><td>The number of decimals the oracle uses.</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="solidity.min.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
